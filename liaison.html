<!DOCTYPE html>
<html lang="pt">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="liaison.css" type="text/css" media="all" />
  <link rel="shortcut icon" href="liaison/laison.png" type="image/x-icon" />
  <title>Liaison</title>

  <style>
    #a {
      text-decoration: none;
      transition: border 0.3s ease;
    }

    a {
      text-decoration: none;
      transition: border 0.3s ease;
    }

    a:hover {
      border-bottom: 3px solid #8B0000;
    }

    a:active {
      border-bottom: 3px solid #8B0000;
    }

    /* 🔹 Badge do chat */
    .chat-link {
      position: relative;
      display: inline-block;
    }

    #chatBadge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: red;
      color: white;
      font-size: 12px;
      font-weight: bold;
      border-radius: 50%;
      padding: 2px 6px;
      min-width: 16px;
      text-align: center;
      display: none;
    }
  </style>
</head>

<body>

  <header>
    <img src="laison2.png" id="logo" alt="Logo" />

    <div id="imagemHade" title="Publicar">
      <img id="profile-pic" src="profile.png" alt="Foto de Perfil" />
      <button onclick="showPostSection()" id="add" style="margin-left:10px;position: fixed;
      top: 90%; cursor:pointer; background:black;border-radius:8px; padding:8px 16px; color:white;">
        +
      </button>
    </div>

    <br />
    <div class="menu">
      <a href="liaison.html" id="a"><img src="home.png" alt="" /></a>
      <a href="home.html"><img src="amigos.png" alt="" /></a>
      <a href="filmes.html"><img src="video.png" alt="" /></a>

      <!-- 🔹 Ícone do chat com badge -->
      <a href="chat.html" id="a" class="chat-link">
        <img src="mensagem.png" alt="Mensagens" />
        <span id="chatBadge">0</span>
      </a>

      <a href="procurar.html"><img src="search.png" alt="" /></a>
      
      <a href="gps.html"><img src="gps.png" alt="" /></a>
    </div>
  </header>

  <br /><br /><br />
  <br /><br /><br />
  <br /><br /><br />

  <!-- Modal de publicação -->
  <section id="postSection">
    <div class="post-box">
      <textarea id="postText" placeholder="Escreva algo..." maxlength="300"></textarea>
      <div class="file-inputs">
        <label for="postImage" class="file-label">📷 Imagem
          <input type="file" id="postImage" accept="image/*" />
        </label>
        <label for="postVideo" class="file-label">🎥 Vídeo
          <input type="file" id="postVideo" accept="video/*" />
        </label>
      </div>
      <small style="color:#aaa;">
        Você pode postar: <strong>Texto + Imagem</strong> ou <strong>Vídeo + Texto</strong>.<br />
        O vídeo deve ter no mínimo 10 segundos (se maior será cortado para 10s). Só é permitido um vídeo por usuário.
      </small>
      <button onclick="submitPost()">Publicar</button>
      <button class="cancel" onclick="hidePostSection()">Cancelar</button>
    </div>
  </section>

  <!-- Feed de publicações -->
  <main id="feed"></main>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import {
      getDatabase,
      ref,
      push,
      set,
      onChildAdded,
      get,
      child,
      update
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    import {
      getStorage,
      ref as storageRef,
      uploadBytes,
      getDownloadURL
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDsP7lNqu-tDpJxpsyv8t1DW0M_u2EAE3o",
      authDomain: "bartolomeu-cruz.firebaseapp.com",
      databaseURL: "https://bartolomeu-cruz-default-rtdb.firebaseio.com",
      projectId: "bartolomeu-cruz",
      storageBucket: "bartolomeu-cruz.appspot.com",
      messagingSenderId: "408863884951",
      appId: "1:408863884951:web:13e8c2282139c1307dcbd2",
      measurementId: "G-8TF4WLHKX3"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const storage = getStorage(app);
    const postsRef = ref(database, 'posts');

    const user = localStorage.getItem('username') || 'Anônimo';
    const profilePic = localStorage.getItem('profilePic') || 'img/default-profile.png';
    document.getElementById("profile-pic").src = profilePic;

    function showPostSection() {
      document.getElementById('postSection').classList.add('active');
      clearPostInputs();
    }
    function hidePostSection() {
      document.getElementById('postSection').classList.remove('active');
      clearPostInputs();
    }
    function clearPostInputs() {
      document.getElementById('postText').value = "";
      document.getElementById('postImage').value = "";
      document.getElementById('postVideo').value = "";
    }
    window.showPostSection = showPostSection;
    window.hidePostSection = hidePostSection;

    // --- código de posts mantido (não repeti tudo para economizar espaço) ---

    // 🔹 FUNÇÃO PARA ATUALIZAR BADGE DO CHAT
    async function updateChatBadge() {
      const currentUser = localStorage.getItem('username');
      if (!currentUser) return;

      let totalUnread = 0;
      const friendsRef = ref(database, `amigos/${currentUser}`);
      const snapshot = await get(friendsRef);

      if (snapshot.exists()) {
        const friends = snapshot.val();
        for (const friendUsername of Object.keys(friends)) {
          const lastReadRef = ref(database, `users/${currentUser}/lastRead/${friendUsername}`);
          const lastReadSnap = await get(lastReadRef);
          const lastRead = lastReadSnap.exists() ? lastReadSnap.val() : 0;

          const chatKey = [currentUser, friendUsername].sort().join('_');
          const messagesRef = ref(database, `chats/${chatKey}/messages`);
          const messagesSnap = await get(messagesRef);

          if (messagesSnap.exists()) {
            const messages = messagesSnap.val();
            Object.values(messages).forEach(msg => {
              if (msg.sender === friendUsername && msg.timestamp > lastRead) {
                totalUnread++;
              }
            });
          }
        }
      }

      const badge = document.getElementById('chatBadge');
      if (totalUnread > 0) {
        badge.textContent = totalUnread;
        badge.style.display = 'inline-block';
      } else {
        badge.style.display = 'none';
      }
    }

    // Atualiza badge ao carregar página
    updateChatBadge();
  </script>
</body>

</html>
